<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>EMMANUEL | Organisateur V3</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }
        .box { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; border-top: 8px solid #d4af37; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 400px; font-family: monospace; padding: 15px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; }
        .btn { background: #1a1a1a; color: white; padding: 15px 35px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .btn:hover { background: #d4af37; }
        .error-log { color: red; font-size: 0.9em; margin-top: 10px; text-align: left; }
    </style>
</head>
<body>

<div class="box">
    <h1>üèõÔ∏è Organisateur V3 (La Forteresse)</h1>
    <p>Collez votre JSON. Je r√©pare les virgules, les points doubles et les crochets.</p>
    
    <textarea id="jsonInput" placeholder="Collez ici..."></textarea>
    
    <button class="btn" onclick="traiterJSON()">‚ö° R√âPARER ET SYNCHRONISER</button>
    <div id="logs" class="error-log"></div>
</div>

<script>
function traiterJSON() {
    let input = document.getElementById('jsonInput').value.trim();
    let logs = document.getElementById('logs');
    logs.innerHTML = "";

    try {
        // --- √âTAPE 1 : NETTOYAGE CHIRURGICAL ---
        // 1. Corriger les doubles points accidentels (:: -> :)
        input = input.replace(/::+/g, ':');
        // 2. Corriger les virgules avant une accolade fermante ( ,} -> } )
        input = input.replace(/,\s*}/g, '}');
        // 3. Corriger les virgules avant un crochet fermant ( ,] -> ] )
        input = input.replace(/,\s*\]/g, ']');
        // 4. S'assurer qu'il y a des crochets au d√©but et √† la fin
        if (!input.startsWith('[')) input = '[' + input;
        if (!input.endsWith(']')) input = input + ']';

        // --- √âTAPE 2 : PARSING ---
        let data = JSON.parse(input);

        // --- √âTAPE 3 : CHRONOLOGIE (BAS VERS LE HAUT) ---
        let dernierIndex = data.length - 1;
        let idActuel = parseInt(data[dernierIndex].id);
        let dateActuelle = new Date(data[dernierIndex].date);

        for (let i = dernierIndex - 1; i >= 0; i--) {
            idActuel++;
            dateActuelle.setDate(dateActuelle.getDate() + 1);

            data[i].id = idActuel;
            let y = dateActuelle.getFullYear();
            let m = String(dateActuelle.getMonth() + 1).padStart(2, '0');
            let d = String(dateActuelle.getDate()).padStart(2, '0');
            data[i].date = `${y}-${m}-${d}`;
        }

        // --- √âTAPE 4 : EXPORT ---
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "data.json";
        a.click();
        
    } catch (e) {
        logs.innerHTML = "‚ùå Erreur de structure : Assurez-vous que chaque message commence par { et finit par }. <br>D√©tail : " + e.message;
    }
}
</script>
</body>
</html>
