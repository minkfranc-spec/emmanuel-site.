<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMMANUEL | L'Ultra-R√©parateur</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }
        .box { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; border-top: 8px solid #d4af37; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { font-family: 'Montserrat', sans-serif; color: #1a1a1a; }
        textarea { width: 100%; height: 450px; font-family: monospace; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background: #fafafa; }
        .btn { background: #1a1a1a; color: white; padding: 15px 35px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 20px; }
        .btn:hover { background: #d4af37; }
    </style>
</head>
<body>

<div class="box">
    <h1>üõ†Ô∏è L'Ultra-R√©parateur JSON</h1>
    <p>Collez votre texte ici. M√™me s'il manque des crochets ou s'il y a des erreurs de virgules/points.</p>
    
    <textarea id="jsonInput" placeholder="Collez votre code ici..."></textarea>
    
    <button class="btn" onclick="superReparation()">‚ö° R√âPARER, CALIBRER ET T√âL√âCHARGER</button>
</div>

<script>
function superReparation() {
    let input = document.getElementById('jsonInput').value;

    // 1. RECONSTRUCTION RADICALE
    // On cherche tous les objets { ... } individuellement
    let objetsTrouves = [];
    let regexObjets = /{[^{]*"id"[^}]*}/g; 
    let match;
    
    while ((match = regexObjets.exec(input)) !== null) {
        let bloc = match[0];
        // Nettoyage interne du bloc (doubles points, virgules mal plac√©es)
        bloc = bloc.replace(/::+/g, ':'); // Change :: en :
        bloc = bloc.replace(/,\s*}/g, '}'); // Enl√®ve la virgule avant }
        try {
            objetsTrouves.push(JSON.parse(bloc));
        } catch(e) {
            // Si JSON.parse √©choue encore, on tente de forcer la r√©paration des guillemets
            try {
                let blocRepare = bloc.replace(/(['"])?([a-z0-9A-Z_]+)(['"])?:/g, '"$2": ');
                objetsTrouves.push(JSON.parse(blocRepare));
            } catch(e2) { console.warn("Bloc ignor√© car trop corrompu : ", bloc); }
        }
    }

    if (objetsTrouves.length === 0) {
        alert("D√©sol√© Ma√Ætre, je n'ai trouv√© aucun message valide dans ce texte.");
        return;
    }

    // 2. CHRONOLOGIE (Du bas vers le haut)
    let dernierIndex = objetsTrouves.length - 1;
    let idActuel = parseInt(objetsTrouves[dernierIndex].id);
    let dateActuelle = new Date(objetsTrouves[dernierIndex].date);

    for (let i = dernierIndex - 1; i >= 0; i--) {
        idActuel++;
        dateActuelle.setDate(dateActuelle.getDate() + 1);

        objetsTrouves[i].id = idActuel;
        let y = dateActuelle.getFullYear();
        let m = String(dateActuelle.getMonth() + 1).padStart(2, '0');
        let d = String(dateActuelle.getDate()).padStart(2, '0');
        objetsTrouves[i].date = `${y}-${m}-${d}`;
    }

    // 3. EXPORTATION PROPRE
    const finalJson = JSON.stringify(objetsTrouves, null, 2);
    const blob = new Blob([finalJson], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "data.json";
    a.click();
}
</script>

</body>
</html>
